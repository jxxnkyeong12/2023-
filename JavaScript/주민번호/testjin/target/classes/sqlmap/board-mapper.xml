<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">

<!-- 조회수 증가시키기 -->
<update id="read">
update board set readcnt = readcnt + 1 
where id = #{id}
</update>

<!-- 공지글 삭제 -->
<delete id="delete">
delete from test_board_jin.board
where id = #{id}
</delete>

<!-- 공지글 삭제 : 기록용 추가 2022-11-20-->
<update id="delete_recode">
update board set history= 'N'
where id = #{id}
</update>

<!-- 공지글 수정 -->
<update id="update">
	update board
	set title = #{title}, content = #{content} 
	   ,filename = #{filename, jdbcType = VARCHAR}
	   ,filepath = #{filepath, jdbcType = VARCHAR}
	where id = #{id}
</update>

<!-- 공지글 상세 -->
<select id="detail" resultType="board.BoardVO">
	select b.*, m.* from board b left outer join member m
	on b.writer = m.mb_email
	where b.id = #{id}
</select>

<!-- 신규 공지글쓰기-->
<insert id="insert">
	insert into board (title, writer, content, filename, filepath )
	values (#{title}, 1 , #{content}
		  , #{filename, jdbcType = VARCHAR}, #{filepath, jdbcType = VARCHAR})

</insert>



<sql id='like'>
	LIKE CONCAT('%',#{keyword},'%')
</sql>


<!-- 공지글 전체조회 -->
<!-- <select id="list" resultType="board.BoardVO">
	select *
	from (select row_number() over(order by b.id) no, b.*, mb_name 
	      from board b left outer join member m on b.writer=m.mb_email <include refid="search_where"/>)
	      n
	where no between #{beginList} and #{endList}    
	and history = 'N'
	order by no desc 
</select> -->
<select id="list" resultType="board.BoardVO">
	select *
	from ( select @rownum:=@rownum+1 as no, b.*, mb_name 
	       from board b left join member m 
	       on b.writer=m.mb_email, (SELECT @rownum:=0) TMP 
	       where b.history= 'Y' <include refid="search_where"/>) n
	where no BETWEEN #{beginList} and #{endList}
	order by no desc 	 
</select>



<!-- 검색조건 -->
<sql id='search_where'>
	<choose>
		<when test="search=='title' or search=='content'">
		and ${search} <include refid="like"/>
		</when>
		<when test="search=='all'">
		and title <include refid="like"/>
		or content <include refid="like"/>
		or writer in (select mb_email from member where mb_name <include refid="like"/>)
		</when>
		<when test="search=='writer'">
		and writer in (select mb_email from member where mb_name <include refid="like"/>)
		</when>
		<when test="search=='t_c'">
		and title <include refid="like"/>
		or content <include refid="like"/>
		</when>
		<otherwise>
		</otherwise>
	</choose>
</sql>


<!-- 공지글 총 건수 조회 -->
<select id="totalList" resultType="integer">
	select count(*) from board where 1=1 <include refid="search_where"/>
</select>

</mapper>